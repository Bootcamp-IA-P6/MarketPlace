{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Looping Marketplace</title>

    <!-- Swiper styles (carousel library) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

    <!-- Project main stylesheet -->
    <link rel="stylesheet" href="{% static 'styles.css' %}" />

    <!-- SweetAlert2 (nice popups) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Stripe checkout library -->
    <script src="https://js.stripe.com/v3/"></script>
</head>

<body>

    <!-- ========================= -->
    <!-- NAVBAR -->
    <!-- ========================= -->
    <header class="navbar">
        <div class="nav-inner">

            <!-- Brand logo -->
            <div class="nav-left">
                <img src="{% static 'images/logo.png' %}" alt="Looping" class="logo">
            </div>

            <!-- Right side actions (auth-based) -->
            <div class="nav-right">

                {% if user.is_authenticated %}
                <!-- Favorites link -->
                <a href="{% url 'favorites' %}" class="icon-btn" aria-label="Favorites" style="text-decoration:none;">
                    <svg viewBox="0 0 24 24" class="icon">
                        <path d="M12 21s-7-4.35-7-10a4 4 0 018-1 4 4 0 018 1c0 5.65-7 10-7 10z" />
                    </svg>
                </a>

                <!-- Shopping cart link -->
                <a href="{% url 'shopping_cart' %}" class="icon-btn" aria-label="Cart" style="text-decoration:none;">
                    <svg viewBox="0 0 24 24" class="icon">
                        <path d="M6 6h15l-2 9H7L6 6z" />
                        <circle cx="9" cy="20" r="1.5" />
                        <circle cx="18" cy="20" r="1.5" />
                    </svg>
                </a>

                <!-- Profile page -->
                <a href="{% url 'user_profile' %}" class="login-btn">MY PROFILE</a>

                <!-- Logout (must be POST) -->
                <form action="{% url 'logout' %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="login-btn" style="cursor:pointer;">LOG OUT</button>
                </form>

                {% else %}
                <!-- Guests: redirect to login when clicking icons -->
                <a href="{% url 'login' %}?next={{ request.get_full_path|urlencode }}" class="icon-btn"
                    aria-label="Favorites" style="text-decoration:none;">
                    <svg viewBox="0 0 24 24" class="icon">
                        <path d="M12 21s-7-4.35-7-10a4 4 0 018-1 4 4 0 018 1c0 5.65-7 10-7 10z" />
                    </svg>
                </a>

                <a href="{% url 'login' %}?next={{ request.get_full_path|urlencode }}" class="icon-btn"
                    aria-label="Cart" style="text-decoration:none;">
                    <svg viewBox="0 0 24 24" class="icon">
                        <path d="M6 6h15l-2 9H7L6 6z" />
                        <circle cx="9" cy="20" r="1.5" />
                        <circle cx="18" cy="20" r="1.5" />
                    </svg>
                </a>

                <!-- Login button -->
                <a href="{% url 'login' %}?next={{ request.get_full_path|urlencode }}" class="login-btn">LOG IN</a>
                {% endif %}

            </div>
        </div>
    </header>

    <!-- ========================= -->
    <!-- HERO CAROUSEL -->
    <!-- ========================= -->
    <section class="hero-carousel">
        <div class="swiper mySwiper">
            <div class="swiper-wrapper">

                {# Real products (max 5) #}
                {% for product in products|slice:":5" %}
                <div class="swiper-slide">
                    <!-- Click slide to open product detail page -->
                    <a class="slide-link" href="{% url 'product_detail' product.id %}">
                        <img src="{{ product.image }}" alt="{{ product.name }}">
                        <div class="slide-info">
                            <h2>{{ product.name }}</h2>
                            <p>â‚¬{{ product.price }}</p>
                        </div>
                    </a>
                </div>
                {% endfor %}

                {# Fill remaining slots with placeholders until we reach 5 slides #}
                {% with total=products|slice:":5"|length %}

                {% if total == 0 %}
                {# No products: show 5 placeholders #}
                {% for _ in "12345" %}
                <div class="swiper-slide is-placeholder">
                    <img src="{% static 'images/product-placeholder.jpg' %}" alt="Placeholder">
                </div>
                {% endfor %}

                {% elif total == 1 %}
                {# 1 product: add 4 placeholders #}
                {% for _ in "1234" %}
                <div class="swiper-slide is-placeholder">
                    <img src="{% static 'images/product-placeholder.jpg' %}" alt="Placeholder">
                </div>
                {% endfor %}

                {% elif total == 2 %}
                {# 2 products: add 3 placeholders #}
                {% for _ in "123" %}
                <div class="swiper-slide is-placeholder">
                    <img src="{% static 'images/product-placeholder.jpg' %}" alt="Placeholder">
                </div>
                {% endfor %}

                {% elif total == 3 %}
                {# 3 products: add 2 placeholders #}
                {% for _ in "12" %}
                <div class="swiper-slide is-placeholder">
                    <img src="{% static 'images/product-placeholder.jpg' %}" alt="Placeholder">
                </div>
                {% endfor %}

                {% elif total == 4 %}
                {# 4 products: add 1 placeholder #}
                <div class="swiper-slide is-placeholder">
                    <img src="{% static 'images/product-placeholder.jpg' %}" alt="Placeholder">
                </div>
                {% endif %}

                {% endwith %}

            </div>

            <!-- Carousel arrows -->
            <div class="swiper-button-prev"></div>
            <div class="swiper-button-next"></div>
        </div>
    </section>

    <!-- ========================= -->
    <!-- JS FILES -->
    <!-- ========================= -->
    <!-- Swiper core script -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <!-- Your carousel setup -->
    <script src="{% static 'carousel.js' %}"></script>

    <script>
        // Stripe client (public key)
        const stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");

        // Auth flag used by buttons
        const isAuthenticated = "{% if user.is_authenticated %}true{% else %}false{% endif %}" === "true";

        // Toggle favorites (with login guard)
        function handleFavorite(productId) {
            if (!isAuthenticated) {
                Swal.fire({
                    title: 'Login Required',
                    text: 'You must be logged in to manage favorites. Do you want to login?',
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, login',
                    cancelButtonText: 'No'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = "{% url 'login' %}?next={{ request.get_full_path|urlencode }}";
                    }
                });
                return;
            }

            const btn = document.getElementById(`fav-btn-${productId}`);
            const isFavorite = btn.innerHTML.includes("Remove");

            if (isFavorite) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: 'Do you want to remove this from favorites?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, remove it',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        executeToggle(productId);
                        Swal.fire({ title: 'Removed!', icon: 'success', timer: 1000, showConfirmButton: false })
                            .then(() => window.location.reload());
                    }
                });
            } else {
                executeToggle(productId);
                Swal.fire({ title: 'Added!', icon: 'success', timer: 1000, showConfirmButton: false });
            }
        }

        // Favorites request (AJAX)
        function executeToggle(productId) {
            fetch(`/toggle-favorites/${productId}/`, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const btn = document.getElementById(`fav-btn-${productId}`);
                        btn.innerHTML = (data.action === "added") ? "Remove â¤ï¸" : "Fav ðŸ¤";
                    }
                })
                .catch(err => console.error("Error:", err));
        }

        // Stripe purchase confirmation
        function confirmPurchase(productId) {
            Swal.fire({
                title: 'Looping',
                text: 'Are you sure you want to buy this product?',
                iconHtml: 'ðŸ›’',
                showCancelButton: true,
                confirmButtonText: 'Yes, buy',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/create-checkout-session/${productId}/`)
                        .then(res => res.json())
                        .then(data => stripe.redirectToCheckout({ sessionId: data.id }));
                }
            });
        }

        // Delete confirmation (owner only)
        function confirmDelete(productId) {
            Swal.fire({
                title: 'Looping',
                text: 'Are you sure you want to delete this product?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = `/product/delete/${productId}/`;
                }
            });
        }

        // Toggle cart (with login guard)
        function handleCart(productId) {
            if (!isAuthenticated) {
                Swal.fire({
                    title: 'Login Required',
                    text: 'You must be logged in to manage your cart. Do you want to login?',
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, login',
                    cancelButtonText: 'No'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = "{% url 'login' %}?next={{ request.get_full_path|urlencode }}";
                    }
                });
                return;
            }

            const btn = document.getElementById(`cart-btn-${productId}`);
            const isInCart = btn.innerHTML.includes("Remove");

            if (isInCart) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: 'Remove this product from your cart?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, remove',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        executeCartToggle(productId);
                        Swal.fire({ title: 'Removed!', icon: 'success', timer: 1000, showConfirmButton: false });
                    }
                });
            } else {
                executeCartToggle(productId);
                Swal.fire({ title: 'Added!', icon: 'success', timer: 1000, showConfirmButton: false });
            }
        }

        // Cart request (AJAX)
        function executeCartToggle(productId) {
            fetch(`/toggle-shopping-cart/${productId}/`, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const btn = document.getElementById(`cart-btn-${productId}`);
                        btn.innerHTML = (data.action === "added") ? "Remove ðŸ›’âŒ" : "Add ðŸ›’";
                    }
                })
                .catch(err => console.error("Error:", err));
        }
    </script>

</body>

</html>
