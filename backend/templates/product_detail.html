{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.name }} | Looping</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://js.stripe.com/v3/"></script>
</head>

<body class="bg-light">

    <nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm" style="height: 60px;">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="{% url 'main_page' %}">
                <img src="{% static 'images/logo3.png' %}" alt="Looping"
                    style="height: 80px; object-fit: contain; margin-left: -20px;">
            </a>
            <div class="d-flex align-items-center gap-3">
                {% if user.is_authenticated %}
                <a href="{% url 'user_profile' %}"
                    class="btn btn-info rounded-pill px-3 fw-bold text-white shadow-sm">My Profile</a>
                <form action="{% url 'logout' %}" method="post" class="d-inline m-0">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-secondary rounded-pill px-3 fw-bold shadow-sm">Log
                        Out</button>
                </form>
                {% else %}
                <a href="{% url 'login' %}" class="btn btn-info rounded-pill px-3 fw-bold text-white shadow-sm">Log
                    In</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container mt-5 mb-5">
        <div class="mb-4 text-start">
            <a href="{% url 'main_page' %}" class="btn btn-outline-primary rounded-pill px-4 shadow-sm fw-bold">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                    class="bi bi-arrow-left me-2" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z" />
                </svg>
                Back to Main Page
            </a>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card border-0 shadow-lg overflow-hidden" style="border-radius: 25px;">
                    <div class="row g-0">
                        <div class="col-md-6 bg-white d-flex align-items-center justify-content-center p-4">
                            <img src="{{ product.image }}" alt="{{ product.name }}" class="img-fluid"
                                style="max-height: 400px; object-fit: contain; border-radius: 15px;">
                        </div>

                        <div class="col-md-6 bg-white p-5 d-flex flex-column">
                            <h2 class="fw-bold text-primary mb-3">{{ product.name }}</h2>
                            <h3 class="text-dark fw-bold mb-4">{{ product.price }}‚Ç¨</h3>

                            <div class="mb-4 text-start">
                                <p class="text-muted mb-1 small text-uppercase fw-bold">Description</p>
                                <p class="text-secondary">{{ product.description }}</p>

                                <div class="mt-3">
                                    <p class="mb-1"><strong>Location:</strong> {{ product.location.city_name }},
                                        {{ product.location.country_name }}</p>
                                    <p class="mb-1"><strong>Quantity:</strong> {{ product.quantity }}</p>
                                    <p class="mb-1"><strong>Seller:</strong> @{{ product.seller.user.username }}</p>
                                </div>
                            </div>

                            <div class="mt-auto d-grid gap-3">
                                {% if user.is_authenticated %}
                                {% if product.seller.user != user %}
                                {% if product.is_available and not product.is_sold %}
                                <button onclick="confirmPurchase('{{ product.id }}')"
                                    class="btn btn-primary btn-lg rounded-pill fw-bold shadow-sm py-3">
                                    Buy Now üõí
                                </button>

                                <button id="cart-btn-{{ product.id }}" onclick="handleCart('{{ product.id }}')"
                                    class="btn btn-outline-info btn-lg rounded-pill fw-bold shadow-sm py-2">
                                    {% if product.id in cart_products %}
                                    Remove from Cart ‚ùå
                                    {% else %}
                                    Add to Cart üõí
                                    {% endif %}
                                </button>
                                {% else %}
                                <div class="alert alert-secondary text-center rounded-pill fw-bold">This product is no
                                    longer available.</div>
                                {% endif %}
                                {% else %}
                                <button onclick="confirmDelete('{{ product.id }}')"
                                    class="btn btn-outline-secondary rounded-pill fw-bold py-2 shadow-sm">
                                    Delete My Listing
                                </button>
                                {% endif %}
                                {% else %}
                                <a href="{% url 'login' %}?next={{ request.get_full_path|urlencode }}"
                                    class="btn btn-info text-white btn-lg rounded-pill fw-bold shadow-sm py-3">
                                    Login to Buy
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");
        const isAuthenticated = "{{ user.is_authenticated|yesno:'true,false' }}" === "true";

        const loopingSwalStyle = {
            confirmButton: 'rounded-pill fw-bold px-4 btn btn-info text-white mx-2',
            cancelButton: 'rounded-pill fw-bold px-4 btn btn-outline-secondary mx-2'
        };

        function confirmPurchase(productId) {
            Swal.fire({
                title: 'Looping',
                text: 'Are you sure you want to buy this product?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, buy',
                buttonsStyling: false,
                customClass: loopingSwalStyle
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/create-checkout-session/${productId}/`)
                        .then(res => res.json())
                        .then(data => {
                            stripe.redirectToCheckout({ sessionId: data.id });
                        });
                }
            });
        }

        function handleCart(productId) {
            if (!isAuthenticated) {
                window.location.href = "{% url 'login' %}";
                return;
            }
            executeCartToggle(productId);
        }

        function executeCartToggle(productId) {
            fetch(`/toggle-shopping-cart/${productId}/`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(response => response.json())
                .then(data => {
                    const btn = document.getElementById(`cart-btn-${productId}`);
                    btn.innerHTML = data.action === "added" ? "Remove from Cart ‚ùå" : "Add to Cart üõí";

                    Swal.fire({
                        title: data.action === "added" ? 'Added to Cart' : 'Removed from Cart',
                        icon: 'success',
                        timer: 1000,
                        showConfirmButton: false
                    });
                });
        }

        function confirmDelete(productId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "Do you want to delete this product? This action is permanent.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete',
                buttonsStyling: false,
                customClass: loopingSwalStyle
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = `/product/delete/${productId}/`;
                }
            });
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    {% include 'footer.html' %}
</body>

</html>